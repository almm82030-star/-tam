<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªÙ… - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #111 0%, #222 100%);
            color: white;
            margin: 0;
            padding: 20px;
            text-align: center;
            min-height: 100vh;
        }
        .card {
            background: #1c1c1c;
            padding: 25px;
            margin: 20px auto;
            border-radius: 18px;
            max-width: 1400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #333;
        }
        input, button {
            width: 100%;
            padding: 14px;
            margin-top: 12px;
            border-radius: 12px;
            border: none;
            font-size: 16px;
            box-sizing: border-box;
        }
        input {
            background: #2a2a2a;
            color: white;
            border: 1px solid #444;
        }
        button {
            background: linear-gradient(to right, #0d6efd, #0b5ed7);
            color: white;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(13, 110, 253, 0.4);
        }
        button.logout {
            background: linear-gradient(to right, #dc3545, #c82333);
            margin-top: 20px;
        }
        button.delete-btn {
            background: linear-gradient(to right, #dc3545, #c82333);
            padding: 8px 15px;
            font-size: 14px;
        }
        button.delete-btn:hover {
            background: linear-gradient(to right, #e74c3c, #c0392b);
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        th {
            background: rgba(13, 110, 253, 0.3);
            padding: 15px 10px;
            border: 1px solid #444;
            font-weight: bold;
            font-size: 15px;
        }
        td {
            padding: 12px 10px;
            border: 1px solid #444;
            text-align: center;
        }
        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-box {
            background: rgba(13, 110, 253, 0.15);
            padding: 20px;
            border-radius: 15px;
            border-right: 5px solid #0d6efd;
            transition: transform 0.3s ease;
        }
        .stat-box:hover {
            transform: translateY(-5px);
            background: rgba(13, 110, 253, 0.2);
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #0d6efd;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 15px;
            color: #aaa;
        }
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }
        .filters select, .filters input {
            flex: 1;
            min-width: 180px;
            max-width: 220px;
            padding: 12px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .page-btn {
            padding: 10px 18px;
            background: #2a2a2a;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #444;
            transition: all 0.3s ease;
        }
        .page-btn:hover {
            background: #333;
            border-color: #0d6efd;
        }
        .page-btn.active {
            background: #0d6efd;
            border-color: #0d6efd;
            font-weight: bold;
        }
        .search-box {
            margin-bottom: 20px;
        }
        .search-box input {
            max-width: 400px;
            margin: 0 auto;
            display: block;
            padding: 15px;
            font-size: 16px;
        }
        .total-stats {
            background: rgba(40, 167, 69, 0.1);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 25px 0;
        }
        .total-stats h4 {
            color: #28a745;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .total-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .total-stat-item {
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .no-data {
            padding: 40px;
            color: #aaa;
            font-size: 18px;
            text-align: center;
        }
        .loading {
            padding: 30px;
            color: #0d6efd;
            font-size: 16px;
        }
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: center;
            }
            .filters select, .filters input {
                min-width: 100%;
                max-width: 100%;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 8px 5px;
            }
            .stat-box {
                padding: 15px;
            }
            .stat-value {
                font-size: 22px;
            }
        }
    </style>
</head>
<body>

<div id="loginBox" class="card">
    <h3>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h3>
    <input id="user" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
    <input id="pass" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button onclick="login()">Ø¯Ø®ÙˆÙ„</button>
</div>

<div id="admin" class="card" style="display:none">
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø¬Ù…ÙŠØ¹ Ø·Ù„Ø¨Ø§Øª Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚ÙˆØ¯</h3>
    
    <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª..." onkeyup="searchTable()">
    </div>
    
    <div class="stats" id="stats">
        <div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</div>
    </div>
    
    <div class="filters">
        <select id="filterCity" onchange="filterTable()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†</option>
        </select>
        <select id="filterCar" onchange="filterTable()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>
        </select>
        <select id="filterFuel" onchange="filterTable()">
            <option value="">Ø¬Ù…ÙŠØ¹ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯</option>
            <option value="91">Ø¨Ù†Ø²ÙŠÙ† 91</option>
            <option value="95">Ø¨Ù†Ø²ÙŠÙ† 95</option>
            <option value="diesel">Ø¯ÙŠØ²Ù„</option>
        </select>
        <input type="date" id="filterDate" onchange="filterTable()">
        <button onclick="clearFilters()">ğŸ—‘ï¸ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·</button>
        <button onclick="exportData()" style="background: linear-gradient(to right, #28a745, #1e7e34);">
            ğŸ“Š ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </button>
    </div>
    
    <div class="total-stats" id="totalStats" style="display: none;">
        <h4>ğŸ“ˆ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©</h4>
        <div class="total-stats-grid" id="totalStatsGrid"></div>
    </div>
    
    <div style="overflow-x: auto;">
        <table id="requestsTable">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Ù…Ù†</th>
                    <th>Ø¥Ù„Ù‰</th>
                    <th>Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</th>
                    <th>Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±)</th>
                    <th>Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</th>
                    <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                    <th>Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯</th>
                    <th>Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª</th>
                    <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
            </thead>
            <tbody id="tblReq">
                <tr>
                    <td colspan="10" class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="pagination" id="pagination"></div>
    
    <button onclick="logout()" class="logout">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
</div>

<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-database.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBkOM7eSnUJ0B_3Mx4wVyh-lTvFEAhxWas",
    authDomain: "tama-6219c.firebaseapp.com",
    databaseURL: "https://tama-6219c-default-rtdb.firebaseio.com",
    projectId: "tama-6219c",
    storageBucket: "tama-6219c.appspot.com",
    messagingSenderId: "285162278384",
    appId: "1:285162278384:web:8264d5439564660b616135"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let allRequests = [];
let filteredRequests = [];
let currentPage = 1;
const itemsPerPage = 20;

// Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
const carTypes = {
    "peugeot301": "Ø¨ÙŠØ¬Ùˆ 301",
    "sedan": "Ø³ÙŠØ§Ø±Ø© Ø³ÙŠØ¯Ø§Ù†",
    "kiaSportage": "ÙƒÙŠØ§ Ø³Ø¨ÙˆØ±ØªØ§Ø¬",
    "suv": "Ø³ÙŠØ§Ø±Ø© Ø¯ÙØ¹ Ø±Ø¨Ø§Ø¹ÙŠ",
    "gmcSierra": "GMC Ø³ÙŠÙŠØ±Ø§",
    "pegas": "Ø¨ÙŠØ¬Ø§Ø³",
    "dieselTruck": "Ø´Ø§Ø­Ù†Ø© Ø¯ÙŠØ²Ù„"
};

// Ø£Ø³Ù…Ø§Ø¡ Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯
const fuelTypes = {
    "91": "Ø¨Ù†Ø²ÙŠÙ† 91",
    "95": "Ø¨Ù†Ø²ÙŠÙ† 95",
    "diesel": "Ø¯ÙŠØ²Ù„"
};

function login() {
    const user = document.getElementById("user").value;
    const pass = document.getElementById("pass").value;
    
    // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    if (user === "admin" && pass === "admin123") {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("admin").style.display = "block";
        loadAllRequests();
    } else if (user === "petroapp" && pass === "212775") {
        document.getElementById("loginBox").style.display = "none";
        document.getElementById("admin").style.display = "block";
        loadAllRequests();
    } else {
        alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
    }
}

function logout() {
    document.getElementById("loginBox").style.display = "block";
    document.getElementById("admin").style.display = "none";
    document.getElementById("user").value = "";
    document.getElementById("pass").value = "";
}

function loadAllRequests() {
    const tbl = document.getElementById("tblReq");
    const statsDiv = document.getElementById("stats");
    
    statsDiv.innerHTML = '<div class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</div>';
    tbl.innerHTML = '<tr><td colspan="10" class="loading">Ø¬Ø§Ø±Ù ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
    
    // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­
    db.ref("fuel_requests").orderByChild("timestamp").once("value", snapshot => {
        allRequests = [];
        filteredRequests = [];
        
        if (snapshot.exists()) {
            snapshot.forEach(s => {
                const request = s.val();
                request.id = s.key;
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨ ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹
                allRequests.unshift(request);
            });
            
            filteredRequests = [...allRequests];
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            updateStatistics();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙ„Ø§ØªØ±
            updateFilters();
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            displayPage(1);
            
            console.log(`âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ ${allRequests.length} Ø·Ù„Ø¨`);
            
        } else {
            // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª
            statsDiv.innerHTML = `
                <div class="stat-box">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">0.00</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">0</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚ÙˆØ¯</div>
                </div>
            `;
            
            tbl.innerHTML = '<tr><td colspan="10" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§</td></tr>';
            
            document.getElementById("totalStats").style.display = "none";
            document.getElementById("pagination").innerHTML = "";
            
            console.log("â„¹ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        }
    }).catch(error => {
        console.error("âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        statsDiv.innerHTML = '<div class="no-data">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        tbl.innerHTML = '<tr><td colspan="10" class="no-data">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…</td></tr>';
    });
}

function updateStatistics() {
    const statsDiv = document.getElementById("stats");
    const totalStatsDiv = document.getElementById("totalStats");
    const totalStatsGrid = document.getElementById("totalStatsGrid");
    
    if (allRequests.length === 0) {
        statsDiv.innerHTML = '<div class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
        totalStatsDiv.style.display = "none";
        return;
    }
    
    let totalCost = 0;
    let totalDistance = 0;
    let totalFuel = 0;
    let todayCount = 0;
    let todayCost = 0;
    
    const today = new Date().toDateString();
    
    allRequests.forEach(request => {
        const cost = parseFloat(request.totalCost || request.cost) || 0;
        const distance = parseFloat(request.distance || request.km) || 0;
        const fuel = parseFloat(request.fuelNeeded || request.liters) || 0;
        
        totalCost += cost;
        totalDistance += distance;
        totalFuel += fuel;
        
        // Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…
        const requestDate = new Date(request.timestamp || request.date).toDateString();
        if (requestDate === today) {
            todayCount++;
            todayCost += cost;
        }
    });
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¶
    statsDiv.innerHTML = `
        <div class="stat-box">
            <div class="stat-value">${allRequests.length}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${totalCost.toFixed(2)}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„)</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${totalDistance.toFixed(1)}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</div>
        </div>
        <div class="stat-box">
            <div class="stat-value">${totalFuel.toFixed(1)}</div>
            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±)</div>
        </div>
    `;
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙƒÙ„ÙŠØ©
    totalStatsGrid.innerHTML = `
        <div class="total-stat-item">
            <div style="color: #4dabf7; font-weight: bold; font-size: 16px;">${todayCount}</div>
            <div style="color: #aaa; font-size: 14px;">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="total-stat-item">
            <div style="color: #28a745; font-weight: bold; font-size: 16px;">${todayCost.toFixed(2)}</div>
            <div style="color: #aaa; font-size: 14px;">ØªÙƒÙ„ÙØ© Ø§Ù„ÙŠÙˆÙ… (Ø±ÙŠØ§Ù„)</div>
        </div>
        <div class="total-stat-item">
            <div style="color: #ffcc00; font-weight: bold; font-size: 16px;">${(totalCost / allRequests.length).toFixed(2)}</div>
            <div style="color: #aaa; font-size: 14px;">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙƒÙ„ÙØ©</div>
        </div>
        <div class="total-stat-item">
            <div style="color: #ff6b6b; font-weight: bold; font-size: 16px;">${(totalDistance / allRequests.length).toFixed(1)}</div>
            <div style="color: #aaa; font-size: 14px;">Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)</div>
        </div>
    `;
    
    totalStatsDiv.style.display = "block";
}

function updateFilters() {
    const cityFilter = document.getElementById("filterCity");
    const carFilter = document.getElementById("filterCar");
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¯Ù†
    const citiesSet = new Set();
    allRequests.forEach(req => {
        if (req.from) citiesSet.add(req.from);
        if (req.to) citiesSet.add(req.to);
    });
    
    cityFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯Ù†</option>';
    Array.from(citiesSet).sort().forEach(city => {
        const option = document.createElement("option");
        option.value = city;
        option.textContent = city;
        cityFilter.appendChild(option);
    });
    
    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª
    carFilter.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option>';
    Object.entries(carTypes).forEach(([key, name]) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = name;
        carFilter.appendChild(option);
    });
}

function filterTable() {
    const city = document.getElementById("filterCity").value;
    const car = document.getElementById("filterCar").value;
    const fuel = document.getElementById("filterFuel").value;
    const date = document.getElementById("filterDate").value;
    
    filteredRequests = allRequests.filter(request => {
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
        if (city && request.from !== city && request.to !== city) {
            return false;
        }
        
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„Ø³ÙŠØ§Ø±Ø©
        if (car && request.carModel !== car && request.car !== car) {
            return false;
        }
        
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚ÙˆØ¯
        if (fuel && request.fuelType !== fuel && request.fuel !== fuel) {
            return false;
        }
        
        // ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
        if (date) {
            const requestDate = new Date(request.timestamp || request.date);
            const filterDate = new Date(date);
            
            if (requestDate.toDateString() !== filterDate.toDateString()) {
                return false;
            }
        }
        
        return true;
    });
    
    displayPage(1);
}

function searchTable() {
    const searchTerm = document.getElementById("searchInput").value.toLowerCase();
    
    if (!searchTerm) {
        filteredRequests = [...allRequests];
    } else {
        filteredRequests = allRequests.filter(request => {
            return (
                (request.from && request.from.toLowerCase().includes(searchTerm)) ||
                (request.to && request.to.toLowerCase().includes(searchTerm)) ||
                (request.carModel && carTypes[request.carModel] && carTypes[request.carModel].toLowerCase().includes(searchTerm)) ||
                (request.car && carTypes[request.car] && carTypes[request.car].toLowerCase().includes(searchTerm)) ||
                (request.fuelType && fuelTypes[request.fuelType] && fuelTypes[request.fuelType].toLowerCase().includes(searchTerm)) ||
                (request.fuel && fuelTypes[request.fuel] && fuelTypes[request.fuel].toLowerCase().includes(searchTerm))
            );
        });
    }
    
    displayPage(1);
}

function clearFilters() {
    document.getElementById("filterCity").value = "";
    document.getElementById("filterCar").value = "";
    document.getElementById("filterFuel").value = "";
    document.getElementById("filterDate").value = "";
    document.getElementById("searchInput").value = "";
    
    filteredRequests = [...allRequests];
    displayPage(1);
}

function displayPage(page) {
    currentPage = page;
    const tbl = document.getElementById("tblReq");
    const pagination = document.getElementById("pagination");
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„ØµÙØ­Ø§Øª
    const totalPages = Math.ceil(filteredRequests.length / itemsPerPage);
    const startIndex = (page - 1) * itemsPerPage;
    const endIndex = Math.min(startIndex + itemsPerPage, filteredRequests.length);
    const pageRequests = filteredRequests.slice(startIndex, endIndex);
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    if (pageRequests.length === 0) {
        tbl.innerHTML = '<tr><td colspan="10" class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¨Ø­Ø«</td></tr>';
    } else {
        tbl.innerHTML = "";
        
        pageRequests.forEach((req, index) => {
            const tr = document.createElement("tr");
            const globalIndex = startIndex + index + 1;
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙˆØ§Ù„ÙˆÙ‚ÙˆØ¯
            const carName = carTypes[req.carModel || req.car] || req.carModel || req.car || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            const fuelName = fuelTypes[req.fuelType || req.fuel] || req.fuelType || req.fuel || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
            let displayDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            if (req.date) {
                displayDate = req.date;
            } else if (req.timestamp) {
                try {
                    displayDate = new Date(req.timestamp).toLocaleString('ar-SA');
                } catch (e) {
                    displayDate = req.timestamp;
                }
            }
            
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù‚ÙŠÙ…
            const distance = req.distance || req.km || "0";
            const fuelNeeded = req.fuelNeeded || req.liters || "0";
            const totalCost = req.totalCost || req.cost || "0";
            
            tr.innerHTML = `
                <td>${globalIndex}</td>
                <td>${req.from || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td>
                <td>${req.to || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"}</td>
                <td>${parseFloat(distance).toFixed(1)}</td>
                <td>${parseFloat(fuelNeeded).toFixed(1)}</td>
                <td>${parseFloat(totalCost).toFixed(2)}</td>
                <td>${carName}</td>
                <td>${fuelName}</td>
                <td>${displayDate}</td>
                <td>
                    <div class="action-buttons">
                        <button onclick="deleteRequest('${req.id}')" class="delete-btn">
                            Ø­Ø°Ù
                        </button>
                    </div>
                </td>
            `;
            tbl.appendChild(tr);
        });
    }
    
    // Ø¹Ø±Ø¶ Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
    pagination.innerHTML = "";
    
    if (totalPages > 1) {
        // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰
        if (page > 1) {
            const firstBtn = document.createElement("div");
            firstBtn.className = "page-btn";
            firstBtn.innerHTML = "&laquo;";
            firstBtn.title = "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰";
            firstBtn.onclick = () => displayPage(1);
            pagination.appendChild(firstBtn);
        }
        
        // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
        if (page > 1) {
            const prevBtn = document.createElement("div");
            prevBtn.className = "page-btn";
            prevBtn.innerHTML = "&lsaquo;";
            prevBtn.title = "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©";
            prevBtn.onclick = () => displayPage(page - 1);
            pagination.appendChild(prevBtn);
        }
        
        // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙØ­Ø§Øª
        const startPage = Math.max(1, page - 2);
        const endPage = Math.min(totalPages, page + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            const btn = document.createElement("div");
            btn.className = `page-btn ${i === page ? 'active' : ''}`;
            btn.textContent = i;
            btn.onclick = () => displayPage(i);
            pagination.appendChild(btn);
        }
        
        // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        if (page < totalPages) {
            const nextBtn = document.createElement("div");
            nextBtn.className = "page-btn";
            nextBtn.innerHTML = "&rsaquo;";
            nextBtn.title = "Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
            nextBtn.onclick = () => displayPage(page + 1);
            pagination.appendChild(nextBtn);
        }
        
        // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©
        if (page < totalPages) {
            const lastBtn = document.createElement("div");
            lastBtn.className = "page-btn";
            lastBtn.innerHTML = "&raquo;";
            lastBtn.title = "Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©";
            lastBtn.onclick = () => displayPage(totalPages);
            pagination.appendChild(lastBtn);
        }
    }
}

function deleteRequest(id) {
    if (confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
        db.ref(`fuel_requests/${id}`).remove()
            .then(() => {
                alert("âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­");
                loadAllRequests();
            })
            .catch(error => {
                console.error("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­Ø°Ù:", error);
                alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù");
            });
    }
}

function exportData() {
    if (filteredRequests.length === 0) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±");
        return;
    }
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV
    let csv = "Ø±Ù‚Ù…,Ù…Ù†,Ø¥Ù„Ù‰,Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…),Ø§Ù„ÙˆÙ‚ÙˆØ¯ (Ù„ØªØ±),Ø§Ù„ØªÙƒÙ„ÙØ© (Ø±ÙŠØ§Ù„),Ø§Ù„Ø³ÙŠØ§Ø±Ø©,Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ‚ÙˆØ¯,Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª\n";
    
    filteredRequests.forEach((req, index) => {
        const carName = carTypes[req.carModel || req.car] || req.carModel || req.car || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const fuelName = fuelTypes[req.fuelType || req.fuel] || req.fuelType || req.fuel || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const distance = req.distance || req.km || "0";
        const fuelNeeded = req.fuelNeeded || req.liters || "0";
        const totalCost = req.totalCost || req.cost || "0";
        
        let displayDate = "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        if (req.date) {
            displayDate = req.date;
        } else if (req.timestamp) {
            try {
                displayDate = new Date(req.timestamp).toLocaleString('ar-SA');
            } catch (e) {
                displayDate = req.timestamp;
            }
        }
        
        csv += `${index + 1},"${req.from || ""}","${req.to || ""}",${distance},${fuelNeeded},${totalCost},"${carName}","${fuelName}","${displayDate}"\n`;
    });
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù ÙˆØªÙ†Ø²ÙŠÙ„Ù‡
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    
    const date = new Date().toISOString().slice(0,10);
    link.setAttribute("href", url);
    link.setAttribute("download", `Ø·Ù„Ø¨Ø§Øª_Ø§Ù„ÙˆÙ‚ÙˆØ¯_${date}.csv`);
    link.style.display = 'none';
    
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    alert(`âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${filteredRequests.length} Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
    if (document.getElementById("admin").style.display !== "none") {
        loadAllRequests();
    }
}, 30000);
</script>
</body>
</html>
